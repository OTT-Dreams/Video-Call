<!DOCTYPE html>
<html>
  <head>
    <title>Secure Video Call</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* Styles same as before (unchanged) */
      body {
        margin: 0;
        padding: 0;
        background: #000;
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
      }

      #remoteVideo {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        background: #000;
      }

      #localVideo {
        position: absolute;
        bottom: 85px;
        right: 10px;
        width: 110px;
        height: 150px;
        background: #000;
        border-radius: 10px;
        object-fit: cover;
        border: 1px solid #ccc;
        z-index: 5;
      }

      .top-bar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: row;
        align-items: center;
        z-index: 10;
        gap: 10px;
        background: rgba(0, 0, 0, 0.6);
        padding: 10px 16px;
        border-radius: 24px;
      }

      .id-tap {
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        user-select: none;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .id-wrapper {
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
      }

      #peerIdInput {
        padding: 7px;
        font-size: 14px;
        border-radius: 4px;
        border: none;
        width: 140px;
      }

      #joinBtn {
        padding: 7px 14px;
        font-size: 14px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      #controls {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        background: rgba(20, 20, 20, 0.9);
        padding: 8px 16px;
        border-radius: 32px;
        gap: 12px;
        z-index: 10;
      }

      .ctrl-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background-color: #444;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
        padding: 0;
        transition: background-color 0.3s;
      }

      .ctrl-btn:hover {
        background-color: #666;
      }

      .ctrl-btn img {
        width: 26px;
        height: 26px;
        filter: invert(100%);
      }

      .ctrl-btn.toggled-off {
        background-color: white !important;
      }

      .ctrl-btn.toggled-off img {
        filter: invert(0%);
      }

      .end-call {
        background-color: crimson !important;
      }
    </style>
  </head>
  <body>
    <video id="remoteVideo" autoplay></video>
    <video id="localVideo" autoplay muted></video>

    <!-- Top ID + Join Row -->
    <div class="top-bar" id="topBar">
      <div class="id-tap" id="idDisplay" onclick="copyId()" title="Tap to copy ID">
        ID: <span class="id-wrapper"><span id="peerIdText">Loading...</span></span>
      </div>
      <input type="text" id="peerIdInput" placeholder="Enter Host ID" />
      <button id="joinBtn" onclick="startCall()">Join</button>
    </div>

    <!-- Bottom Controls -->
    <div id="controls">
      <button class="ctrl-btn" id="videoBtn" onclick="toggleVideo()">
        <img src="https://cdn-icons-png.flaticon.com/512/5948/5948966.png" alt="Video">
      </button>
      <button class="ctrl-btn" id="audioBtn" onclick="toggleAudio()">
        <img src="https://cdn-icons-png.flaticon.com/512/5561/5561764.png" alt="Audio">
      </button>
      <button class="ctrl-btn end-call" onclick="endCall()">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733497.png" alt="End">
      </button>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
  // E2EE: Generate shared secret key (same on both peers for now)
  const encoder = new TextEncoder();
  const decoder = new TextDecoder();
  const SHARED_SECRET = "your-256-bit-secret-key--------"; // 32 characters (256-bit)
  let encryptionKey;

  async function setupEncryptionKey() {
    encryptionKey = await crypto.subtle.importKey(
      "raw",
      encoder.encode(SHARED_SECRET),
      { name: "AES-GCM" },
      false,
      ["encrypt", "decrypt"]
    );
  }

  async function createEncryptedStreamTrack(track, isSender) {
    const senderOrReceiver = isSender ? "sender" : "receiver";

    const transform = new TransformStream({
      async transform(chunk, controller) {
        try {
          const iv = crypto.getRandomValues(new Uint8Array(12));
          const encrypted = isSender
            ? await crypto.subtle.encrypt(
                { name: "AES-GCM", iv },
                encryptionKey,
                chunk.data
              )
            : await crypto.subtle.decrypt(
                { name: "AES-GCM", iv: chunk.data.slice(0, 12) },
                encryptionKey,
                chunk.data.slice(12)
              );

          controller.enqueue({
            ...chunk,
            data: isSender
              ? new Uint8Array([...iv, ...new Uint8Array(encrypted)])
              : new Uint8Array(encrypted),
          });
        } catch (err) {
          console.error("E2EE transform error:", err);
        }
      },
    });

    const senderStream = track.writable.pipeThrough(transform);
    return new MediaStreamTrackGenerator(track.kind).writable
      ? track
      : track;
  }

  async function enableE2EE(pc) {
    const senders = pc.getSenders();
    for (const sender of senders) {
      const senderStreams = sender.createEncodedStreams();
      const transform = new TransformStream({
        async transform(chunk, controller) {
          const iv = crypto.getRandomValues(new Uint8Array(12));
          const encrypted = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            encryptionKey,
            chunk.data
          );
          chunk.data = new Uint8Array([...iv, ...new Uint8Array(encrypted)]);
          controller.enqueue(chunk);
        },
      });
      senderStreams.readable.pipeThrough(transform).pipeTo(senderStreams.writable);
    }

    const receivers = pc.getReceivers();
    for (const receiver of receivers) {
      const receiverStreams = receiver.createEncodedStreams();
      const transform = new TransformStream({
        async transform(chunk, controller) {
          const iv = chunk.data.slice(0, 12);
          const encrypted = chunk.data.slice(12);
          try {
            const decrypted = await crypto.subtle.decrypt(
              { name: "AES-GCM", iv },
              encryptionKey,
              encrypted
            );
            chunk.data = new Uint8Array(decrypted);
            controller.enqueue(chunk);
          } catch (e) {
            console.error("Decryption failed:", e);
          }
        },
      });
      receiverStreams.readable.pipeThrough(transform).pipeTo(receiverStreams.writable);
    }
  }

  // Prepare key before usage
  setupEncryptionKey();

  // Then inside startCall or peer.on('call'), after `call = peer.call(...)`:
  call.peerConnection.addEventListener("connectionstatechange", () => {
    if (call.peerConnection.connectionState === "connected") {
      enableE2EE(call.peerConnection);
    }
  });

</script>

    
  </body>
</html>
