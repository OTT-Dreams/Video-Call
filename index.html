<!DOCTYPE html>
<html>
  <head>
    <title>Secure Video Call</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000;
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
      }

      #remoteVideo {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        background: #000;
      }

      #localVideo {
        position: absolute;
        bottom: 85px;
        right: 10px;
        width: 110px;
        height: 150px;
        background: #000;
        border-radius: 10px;
        object-fit: cover;
        border: 1px solid #ccc;
        z-index: 5;
      }

      .top-bar {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: row;
        align-items: center;
        z-index: 10;
        gap: 10px;
        background: rgba(0, 0, 0, 0.6);
        padding: 10px 16px;
        border-radius: 24px;
      }

      .id-tap {
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        user-select: none;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .id-wrapper {
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
      }

      #peerIdInput {
        padding: 7px;
        font-size: 14px;
        border-radius: 4px;
        border: none;
        width: 140px;
      }

      #joinBtn {
        padding: 7px 14px;
        font-size: 14px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      #controls {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        background: rgba(20, 20, 20, 0.9);
        padding: 8px 16px;
        border-radius: 32px;
        gap: 12px;
        z-index: 10;
      }

      .ctrl-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background-color: #444;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
        padding: 0;
      }

      .ctrl-btn:hover {
        background-color: #666;
      }

      .ctrl-btn img {
        width: 26px;
        height: 26px;
        filter: invert(100%);
      }

      .end-call {
        background-color: crimson !important;
      }
    </style>
  </head>
  <body>
    <video id="remoteVideo" autoplay></video>
    <video id="localVideo" autoplay muted></video>

    <!-- Top ID + Join Row -->
    <div class="top-bar" id="topBar">
      <div class="id-tap" id="idDisplay" onclick="copyId()" title="Tap to copy ID">
        ID: <span class="id-wrapper"><span id="peerIdText">Loading...</span></span>
      </div>
      <input type="text" id="peerIdInput" placeholder="Enter Host ID" />
      <button id="joinBtn" onclick="startCall()">Join</button>
    </div>

    <!-- Bottom Controls -->
    <div id="controls">
      <button class="ctrl-btn" onclick="toggleVideo()">
        <img src="https://cdn-icons-png.flaticon.com/512/5948/5948966.png" alt="Video">
      </button>
      <button class="ctrl-btn" onclick="toggleAudio()">
        <img src="https://cdn-icons-png.flaticon.com/512/5561/5561764.png" alt="Audio">
      </button>
      <button class="ctrl-btn end-call" onclick="endCall()">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733497.png" alt="End">
      </button>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
  const peerIdText = document.getElementById('peerIdText');
  const idDisplay = document.getElementById('idDisplay');
  const peerIdInput = document.getElementById('peerIdInput');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const topBar = document.getElementById('topBar');

  let fullPeerId = '';
  let localStream;
  let currentCall;
  const peer = new Peer();

  const encryptionKey = crypto.getRandomValues(new Uint8Array(16)); // symmetric key for E2EE

  function getCryptoKey() {
    return crypto.subtle.importKey(
      "raw",
      encryptionKey,
      { name: "AES-GCM" },
      false,
      ["encrypt", "decrypt"]
    );
  }

  async function encryptTransform(chunk, controller) {
    const key = await getCryptoKey();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encrypted = await crypto.subtle.encrypt(
      { name: "AES-GCM", iv },
      key,
      chunk.data
    );
    const payload = new Uint8Array(12 + encrypted.byteLength);
    payload.set(iv);
    payload.set(new Uint8Array(encrypted), 12);
    controller.enqueue(new EncodedVideoChunk({
      type: chunk.type,
      timestamp: chunk.timestamp,
      data: payload,
      duration: chunk.duration
    }));
  }

  async function decryptTransform(chunk, controller) {
    const key = await getCryptoKey();
    const iv = chunk.data.slice(0, 12);
    const encrypted = chunk.data.slice(12);
    try {
      const decrypted = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        key,
        encrypted
      );
      controller.enqueue(new EncodedVideoChunk({
        type: chunk.type,
        timestamp: chunk.timestamp,
        data: new Uint8Array(decrypted),
        duration: chunk.duration
      }));
    } catch (e) {
      console.error("Decryption failed", e);
    }
  }

  async function setupSenderEncryption(sender) {
    const senderStreams = sender.createEncodedStreams();
    const transformStream = new TransformStream({ transform: encryptTransform });
    senderStreams.readable
      .pipeThrough(transformStream)
      .pipeTo(senderStreams.writable);
  }

  async function setupReceiverDecryption(receiver) {
    const receiverStreams = receiver.createEncodedStreams();
    const transformStream = new TransformStream({ transform: decryptTransform });
    receiverStreams.readable
      .pipeThrough(transformStream)
      .pipeTo(receiverStreams.writable);
  }

  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(async (stream) => {
      localStream = stream;
      localVideo.srcObject = stream;
    })
    .catch((err) => {
      alert("Camera or microphone access denied. Please allow permission and refresh.");
      console.error(err);
    });

  peer.on('open', (id) => {
    fullPeerId = id;
    peerIdText.innerText = id;
    setTimeout(() => {
      peerIdText.innerText = id.slice(0, 6) + '...';
    }, 5000);
  });

  peer.on('call', async (call) => {
    currentCall = call;
    call.answer(localStream);
    call.on('stream', (remoteStream) => {
      remoteVideo.srcObject = remoteStream;
    });

    call.peerConnection.getSenders().forEach(setupSenderEncryption);
    call.peerConnection.getReceivers().forEach(setupReceiverDecryption);

    hideTopBar();
  });

  async function startCall() {
    const remotePeerId = peerIdInput.value.trim();
    if (!remotePeerId) return alert('Enter a Peer ID');
    const call = peer.call(remotePeerId, localStream);
    currentCall = call;

    call.on('stream', (remoteStream) => {
      remoteVideo.srcObject = remoteStream;
    });

    call.peerConnection.getSenders().forEach(setupSenderEncryption);
    call.peerConnection.getReceivers().forEach(setupReceiverDecryption);

    hideTopBar();
  }

  function toggleVideo() {
    const track = localStream.getVideoTracks()[0];
    track.enabled = !track.enabled;
  }

  function toggleAudio() {
    const track = localStream.getAudioTracks()[0];
    track.enabled = !track.enabled;
  }

  function copyId() {
    if (fullPeerId) {
      peerIdText.innerText = fullPeerId;
      navigator.clipboard.writeText(fullPeerId);
      alert("Peer ID copied!");
      setTimeout(() => {
        peerIdText.innerText = fullPeerId.slice(0, 6) + '...';
      }, 4000);
    }
  }

  function endCall() {
    if (currentCall) {
      currentCall.close();
      remoteVideo.srcObject = null;
    }
    showTopBar();
  }

  function hideTopBar() {
    topBar.style.display = 'none';
  }

  function showTopBar() {
    topBar.style.display = 'flex';
  }
</script>

    
  </body>
</html>
